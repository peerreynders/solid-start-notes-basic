import{getRequestEvent as X}from"solid-js/web";import{provideRequestEvent as Z}from"solid-js/web/storage";import{H3Event as N,setResponseStatus as ee,setHeader as te,getRequestIP as re,getResponseStatus as ne,getResponseStatusText as oe,getCookie as se,setCookie as ae,getRequestURL as ce,getResponseHeaders as ie,getResponseHeader as ue,setResponseHeader as le,appendResponseHeader as de,removeResponseHeader as fe,getRequestWebStream as pe}from"h3";import{AsyncLocalStorage as me}from"node:async_hooks";import{createStorage as ge}from"unstorage";import he from"unstorage/drivers/fs-lite";import{Observable as m,operate as M,rx as k}from"rxjs";import{nanoid as O}from"nanoid";import{marked as ye}from"marked";import we from"sanitize-html";function be(e={}){let t,r=!1;const n=o=>{if(t&&t!==o)throw new Error("Context conflict")};let s;if(e.asyncContext){const o=e.AsyncLocalStorage||globalThis.AsyncLocalStorage;o?s=new o:console.warn("[unctx] `AsyncLocalStorage` is not provided.")}const a=()=>{if(s&&t===void 0){const o=s.getStore();if(o!==void 0)return o}return t};return{use:()=>{const o=a();if(o===void 0)throw new Error("Context is not available");return o},tryUse:()=>a(),set:(o,c)=>{c||n(o),t=o,r=!0},unset:()=>{t=void 0,r=!1},call:(o,c)=>{n(o),t=o;try{return s?s.run(o,c):c()}finally{r||(t=void 0)}},async callAsync(o,c){t=o;const i=()=>{t=o},d=()=>t===o?i:void 0;D.add(d);try{const u=s?s.run(o,c):c();return r||(t=void 0),await u}finally{D.delete(d)}}}}function xe(e={}){const t={};return{get(r,n={}){return t[r]||(t[r]=be({...e,...n})),t[r],t[r]}}}const x=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof global<"u"?global:typeof window<"u"?window:{},$="__unctx__",ve=x[$]||(x[$]=xe()),Se=(e,t={})=>ve.get(e,t),I="__unctx_async_handlers__",D=x[I]||(x[I]=new Set);function Re(e){let t;const r=W(e),n={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(r,{...n,body:e.node.req.body}):new Request(r,{...n,get body(){return t||(t=qe(e),t)}})}function Ae(e){return e.web??={request:Re(e),url:W(e)},e.web.request}function Ne(){return Le()}const g=Symbol("$HTTPEvent");function Ce(e){return typeof e=="object"&&(e instanceof N||e?.[g]instanceof N||e?.__is_event__===!0)}function l(e){return function(...t){let r=t[0];if(Ce(r))t[0]=r instanceof N||r.__is_event__?r:r[g];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(r=Ne(),!r)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(r)}return e(...t)}}const W=l(ce),Te=l(re),L=l(ee),P=l(ne),ke=l(oe),y=l(ie),j=l(ue),_e=l(le),He=l(de),xt=l(se),vt=l(ae),Ee=l(te),qe=l(pe),$e=l(fe),Ie=l(Ae);function De(){return Se("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:me})}function Le(){return De().use().event}const A=Symbol("fetchEvent");function Pe(e){return{request:Ie(e),response:Me(e),clientAddress:Te(e),locals:{},nativeEvent:e,[g]:e}}function je(e){return{...e,[g]:e[g]}}function St(e){if(!e[A]){const t=Pe(e);e[A]=t}return e[A]}function Rt(e,t){for(const[r,n]of t.entries())Ee(e,r,n)}class Ue{constructor(t){this.event=t}get(t){const r=j(this.event,t);return Array.isArray(r)?r.join(", "):r}has(t){return this.get(t)!==void 0}set(t,r){return _e(this.event,t,r)}delete(t){return $e(this.event,t)}append(t,r){He(this.event,t,r)}getSetCookie(){const t=j(this.event,"Set-Cookie");return Array.isArray(t)?t:[t]}forEach(t){return Object.entries(y(this.event)).forEach(([r,n])=>t(Array.isArray(n)?n.join(", "):n,r,this))}entries(){return Object.entries(y(this.event)).map(([t,r])=>[t,Array.isArray(r)?r.join(", "):r])[Symbol.iterator]()}keys(){return Object.keys(y(this.event))[Symbol.iterator]()}values(){return Object.values(y(this.event)).map(t=>Array.isArray(t)?t.join(", "):t)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function Me(e){return{get status(){return P(e)},set status(t){L(e,t)},get statusText(){return ke(e)},set statusText(t){L(e,P(),t)},headers:new Ue(e)}}function v(e,t,r){if(typeof e!="function")throw new Error("Export from a 'use server' module must be a function");const n="";return new Proxy(e,{get(s,a,o){if(a==="url")return`${n}/_server/?id=${encodeURIComponent(t)}&name=${encodeURIComponent(r)}`;if(a==="GET")return o},apply(s,a,o){const c=X();if(!c)throw new Error("Cannot call server function outside of a request");const i=je(c);return i.serverOnly=!0,Z(i,()=>e.apply(a,o))}})}const S=e=>({kind:"note-store",notes:e}),Oe=e=>({id:e.id,title:e.title,updatedAt:e.updatedAt,summary:e.excerpt}),We=e=>({id:e.id,title:e.title,body:e.body,createdAt:e.createdAt,updatedAt:e.updatedAt}),U=20;function B(e){const t=ye.parse(e,{async:!1}),n=we(t,{allowedTags:[],allowedAttributes:{}}).trim().split(/\s+/),s=n.slice(0,U).join(" ");return n.length>U?s+"â€¦":s}const f=[["Meeting Notes","This is an example note. It contains **Markdown**!"],["Make a thing",`It's very easy to make some words **bold** and other words *italic* with
Markdown. You can even [link to SolidStart's website!](https://start.solidjs.com/).`],["A note with a very long title because sometimes you need more words","You can write all kinds of [amazing](https://en.wikipedia.org/wiki/The_Amazing)\nnotes in this app! These notes live on the server in the `.data/notes` file.\n![This app is powered by SolidStart](https://assets.solidjs.com/banner?project=Start&amp;type=core)"],["I wrote this note today","It was an excellent note."]];function Be(e,t,r){const[n,s]=t<r?[t,r]:[r,t],a=s-n,o=i=>n+Math.floor(a*i/4294967295),c=new Uint32Array(e);return crypto.getRandomValues(c),c.sort(),Array.prototype.map.call(c,o)}function Fe(e){const t=new Date(e);return new Date(t.getFullYear(),0,1).getTime()}function Ye(e){const t=new m(n=>{let s;const a=[],o=Date.now(),c=Be(f.length,Fe(o),o),i=u=>{s||(s=u,n.error(s))},d=u=>{s||a.length>=f.length||(a.push(u),!(a.length<f.length)&&(n.next(a),n?.complete()))};for(let u=0;u<f.length;u+=1)e(f[u],B(f[u][1]),c[u],o,d,i);n.next(a),n?.complete()});return new m(n=>{t.subscribe(M({destination:n,next:s=>void n.next(S(s)),complete:()=>void n.complete()}))})}const F=ge({driver:he({base:".data"})}),Y=()=>F.getItem("notes");function ze(e,t){const r=t.updatedAt-e.updatedAt;return r!==0?r:t.createdAt-e.createdAt}const z=e=>new m(t=>{let r=!1;const n=c=>{r||(r=!0,t.error(c))};let s=!1,a=!1;const o=()=>{r||!(a&&s)||(r=!0,t.complete())};e.subscribe({error:n,next:c=>{const i=S(c.notes.toSorted(ze));F.setItem("notes",i.notes).then(()=>{t.next(i),s=!0,o()}).catch(n)},complete:()=>{a=!0,o()}})}),_=(e,t,r,n,s,a)=>({id:n,title:e,body:t,excerpt:r,createdAt:s,updatedAt:a});function Ke([e,t],r,n,s,a,o){a(_(e,t,r,O(),n,s))}const K=e=>new m(t=>{let r=!1;const n=i=>{r||(r=!0,t.error(i))};let s=!1,a=!1;const o=()=>{r||!(a&&s)||(r=!0,t.complete())},c=()=>{s=!0,o()};e.subscribe({error:n,next:i=>{if(!r){if(i){t.next(S(i)),c();return}k(Ye(Ke),z).subscribe({error:n,next:d=>{r||t.next(d)},complete:c})}},complete:()=>{a=!0,o()}})});function Ge(e,t){let r=!1,n=!1,s=!1;const a=()=>{r||!(n&&s)||(r=!0,t())};k(Y(),K).subscribe({error:o=>{r||(r=!0,e.reject(o),t())},next:o=>{if(!r){if(e.kind===0){const c=e.predicate?o.notes.filter(e.predicate):o.notes;e.resolve(c)}else e.resolve(o.notes.find(e.predicate));s=!0,a()}},complete:()=>{r||(n=!0,a())}})}function Ve(e,t){let r=!1;const n=d=>{r||(r=!0,e.reject(d),t())};let s=!1,a=!1;const o=()=>{r||!(s&&a)||(r=!0,t())};let c;const i=d=>new m(u=>{let p=!1;const V=R=>{p||(p=!0,u.error(R))};let H=!1,E=!1;const q=()=>{p||!(H&&E)||(p=!0,u.complete())};d.subscribe(M({destination:u,error:V,next:R=>{if(p)return;const[J,Q]=e.update(R.notes);c=Q,E=!0,u.next(S(J)),q()},complete:()=>{H=!0,q()}}))});k(Y(),K,i,z).subscribe({error:n,next:d=>{r||(a=!0,e.resolve(c),o())},complete:()=>{s=!0,o()}})}let C=!1,w=-1;const b=[];function T(){if(w+=1,w>=b.length){b.length=0,w=-1,C=!1;return}const e=b[w];switch(e.kind){case 0:case 1:{Ge(e,T);return}case 2:{Ve(e,T);return}}}function h(e){b.push(e),!C&&(C=!0,queueMicrotask(T))}function Je(e){if(!e)return;const t=e.toLowerCase();return r=>r.title.toLowerCase().includes(t)}function Qe(e){const t=Je(e);return new Promise((r,n)=>{h({kind:0,predicate:t,resolve:r,reject:n})})}function Xe(e){const t=r=>r.id===e;return new Promise((r,n)=>{h({kind:1,predicate:t,resolve:r,reject:n})})}const Ze=e=>t=>{const r=Date.now(),n=_(e.title,e.body,e.excerpt,O(),r,r);return[t.toSpliced(t.length,0,n),n]};function et(e){return new Promise((t,r)=>{h({kind:2,update:Ze(e),resolve:t,reject:r})})}const tt=e=>t=>{const r=t.findIndex(a=>a.id===e.id);if(r<0)return[t,void 0];const n=t[r],s=_(e.title,e.body,e.excerpt,n.id,n.createdAt,Date.now());return[t.toSpliced(r,1,s),s]};function rt(e){return new Promise((t,r)=>{h({kind:2,update:tt(e),resolve:t,reject:r})})}const nt=e=>t=>{const r=t.findIndex(n=>n.id===e);return r>-1?[t.toSpliced(r,1),t[r]]:[t,void 0]};function ot(e){return new Promise((t,r)=>{h({kind:2,update:nt(e),resolve:t,reject:r})})}const st=e=>e.map(Oe),at=e=>Qe(e).then(st),G=e=>e?We(e):void 0,ct=e=>Xe(e).then(G);function it(e,t,r){const n=B(t);return(typeof r=="string"&&r.length>0?rt({id:r,title:e,body:t,excerpt:n}):et({title:e,body:t,excerpt:n})).then(G)}const ut=e=>ot(e).then(t=>t?.id===e),At=v(ut,"c_6666","deleteNote"),Nt=v(at,"c_6666","getBriefs"),Ct=v(ct,"c_6666","getNote"),Tt=v(it,"c_6666","upsertNote");export{Nt as a,Ct as b,St as c,At as d,Ee as e,L as f,xt as g,je as h,Rt as m,vt as s,Tt as u};
